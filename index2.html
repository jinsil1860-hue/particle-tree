<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>圣诞粒子 - 兼容修复版</title>
    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: sans-serif; }
        #debug-panel { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; z-index: 100; font-size: 12px; }
        .success { color: #00ff88; }
        .error { color: #ff4444; }
        #webcam-video { display: none; }
    </style>
</head>
<body>

    <div id="debug-panel">
        <h3 id="main-status">正在加载系统...</h3>
        <div id="check-webgl">WebGL: 检测中...</div>
        <div id="check-cam">摄像头: 检测中...</div>
        <div id="gesture-hint" style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">提示：请在 http 环境下运行</div>
    </div>

    <video id="webcam-video" autoplay playsinline></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        const statusEl = document.getElementById('main-status');
        const webglEl = document.getElementById('check-webgl');
        const camEl = document.getElementById('check-cam');

        // --- 1. 强制 WebGL 检测 ---
        let renderer;
        try {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            webglEl.innerHTML = 'WebGL: <span class="success">正常</span>';
        } catch (e) {
            webglEl.innerHTML = 'WebGL: <span class="error">初始化失败</span>';
        }

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 10;

        // --- 2. 立即创建基础粒子（即便没手势也能看） ---
        const geometry = new THREE.BufferGeometry();
        const count = 8000;
        const posArray = new Float32Array(count * 3);
        for(let i=0; i<count*3; i++) posArray[i] = (Math.random() - 0.5) * 10;
        geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const material = new THREE.PointsMaterial({ color: 0xFFD700, size: 0.08, transparent: true, opacity: 0.8 });
        const points = new THREE.Points(geometry, material);
        scene.add(points);

        function animate() {
            requestAnimationFrame(animate);
            points.rotation.y += 0.002; // 基础旋转
            renderer.render(scene, camera);
        }
        animate();
        statusEl.innerText = "渲染系统已启动";

        // --- 3. 摄像头异步加载 ---
        if (location.protocol === 'file:') {
            camEl.innerHTML = '摄像头: <span class="error">本地文件无法启动 (请使用服务器)</span>';
        } else {
            // 这里放入 MediaPipe 代码...
            camEl.innerHTML = '摄像头: <span class="success">正在请求权限...</span>';
            // 尝试请求媒体设备
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(() => { camEl.innerHTML = '摄像头: <span class="success">已就绪</span>'; })
                .catch(e => { camEl.innerHTML = '摄像头: <span class="error">被禁用或无设备</span>'; });
        }
    </script>
</body>
</html>